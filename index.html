<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ„ AI ë§¤ì§ í¬ë¦¬ìŠ¤ë§ˆìŠ¤ í¬í† ë¶€ìŠ¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- MediaPipe Holistic (ì–¼êµ´+ì†+ëª¸ í†µí•© ëª¨ë¸) -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js" crossorigin="anonymous"></script>

    <style>
        body {
            background-color: #1a1a1a;
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            touch-action: none;
        }
        #canvas-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 0 auto;
            border: 4px solid #ef4444;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
            background-color: #000;
        }
        canvas {
            display: block;
            width: 100%;
            height: auto;
            transform: scaleX(-1); /* ê±°ìš¸ ëª¨ë“œ */
        }
        .btn {
            transition: all 0.2s;
        }
        .btn.active {
            filter: brightness(1.2);
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.4);
            border: 2px solid white;
        }
        
        /* ëˆˆë‚´ë¦¬ëŠ” íš¨ê³¼ */
        .snowflake {
            color: #fff;
            font-size: 1em;
            font-family: Arial;
            text-shadow: 0 0 1px #000;
            position: fixed;
            top: -10%;
            z-index: 9999;
            user-select: none;
            cursor: default;
            animation-name: snowflakes-fall, snowflakes-shake;
            animation-duration: 10s, 3s;
            animation-timing-function: linear, ease-in-out;
            animation-iteration-count: infinite, infinite;
            animation-play-state: running, running;
        }
        @keyframes snowflakes-fall {
            0% { top: -10%; }
            100% { top: 100%; }
        }
        @keyframes snowflakes-shake {
            0% { transform: translateX(0px); }
            50% { transform: translateX(80px); }
            100% { transform: translateX(0px); }
        }

        /* AI ë¡œë”© ì˜¤ë²„ë ˆì´ */
        #ai-loading {
            display: none;
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 50;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="flex flex-col h-screen items-center justify-center p-4">

    <div id="snow-container"></div>

    <div class="text-center mb-4 z-10">
        <h1 class="text-3xl font-bold text-red-500 drop-shadow-md">ğŸ„ AI ë§¤ì§ í¬í† ë¶€ìŠ¤ âœ¨</h1>
        <p class="text-gray-300 text-sm mt-1">ì–¼êµ´ ì¸ì‹ + âœŒï¸ë¸Œì´ í­ì£½ + <span class="text-yellow-300 font-bold">Gemini AI ì¹´ë“œ</span></p>
    </div>

    <!-- ë©”ì¸ ìº”ë²„ìŠ¤ ì˜ì—­ -->
    <div id="canvas-container" class="z-10 relative">
        <video id="video" playsinline style="display:none;"></video>
        <canvas id="canvas"></canvas>
        
        <!-- ëª¨ë¸ ë¡œë”© ë©”ì‹œì§€ -->
        <div id="loading" class="absolute inset-0 flex flex-col items-center justify-center bg-black bg-opacity-90 z-20">
            <div class="w-12 h-12 border-4 border-red-500 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-xl font-bold">ìµœì í™” AI ëª¨ë¸ ë¡œë”© ì¤‘...</p>
            <p class="text-sm text-gray-400 mt-2">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš” (ìµœëŒ€ 10ì´ˆ)</p>
        </div>

        <!-- Gemini AI ì²˜ë¦¬ ì¤‘ ì˜¤ë²„ë ˆì´ -->
        <div id="ai-loading">
            <div class="text-4xl animate-bounce mb-4">âœ¨ğŸ¤–</div>
            <p class="text-xl font-bold text-white">Geminiê°€ ì‚¬ì§„ì„ ë³´ê³  ìˆì–´ìš”...</p>
            <p class="text-sm text-gray-300 mt-2">ì„¼ìŠ¤ ìˆëŠ” ì¶•í•˜ ë©˜íŠ¸ ì‘ì„± ì¤‘!</p>
        </div>
    </div>

    <!-- ì»¨íŠ¸ë¡¤ ë²„íŠ¼ -->
    <div class="flex flex-wrap justify-center gap-3 mt-6 z-10 w-full max-w-2xl">
        <button id="btn-hat" onclick="toggleSticker('hat')" class="btn flex items-center gap-2 px-4 py-3 bg-red-600 hover:bg-red-700 rounded-full font-bold shadow-lg">
            <span>ğŸ…</span> ëª¨ì
        </button>
        <button id="btn-glasses" onclick="toggleSticker('glasses')" class="btn flex items-center gap-2 px-4 py-3 bg-green-600 hover:bg-green-700 rounded-full font-bold shadow-lg">
            <span>ğŸ˜</span> ì•ˆê²½
        </button>
        <button id="btn-beard" onclick="toggleSticker('beard')" class="btn flex items-center gap-2 px-4 py-3 bg-white text-black hover:bg-gray-200 rounded-full font-bold shadow-lg">
            <span>ğŸ§”</span> ìˆ˜ì—¼
        </button>
        <button onclick="resetAll()" class="btn px-4 py-3 bg-gray-600 hover:bg-gray-700 rounded-full font-bold shadow-lg text-white">
            ğŸ”„
        </button>
    </div>

    <!-- í•˜ë‹¨ ì•¡ì…˜ ë²„íŠ¼ -->
    <div class="flex gap-4 mt-4 z-10">
        <button onclick="takePhoto()" class="btn px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-bold shadow-lg text-lg flex items-center gap-2">
            ğŸ“¸ ê·¸ëƒ¥ ì´¬ì˜
        </button>
        <button onclick="generateAICard()" class="btn px-6 py-3 bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600 text-black rounded-lg font-bold shadow-lg text-lg flex items-center gap-2 border-2 border-white">
            âœ¨ AI ì¹´ë“œ ë§Œë“¤ê¸°
        </button>
    </div>

    <script>
        // ==========================================
        // [ì¤‘ìš”] ì—¬ê¸°ì— Google AI Studioì—ì„œ ë°›ì€ API í‚¤ë¥¼ ë„£ìœ¼ì„¸ìš”!
        // ì˜ˆì‹œ: const apiKey = "AIzaSyD...";
        const apiKey = "AIzaSyBcVsAIVggmSUXur0utgvIiG1HLmmfcIq0"; 
        // ==========================================

        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const loading = document.getElementById('loading');
        const aiLoading = document.getElementById('ai-loading');

        // ìƒíƒœ ë³€ìˆ˜
        const activeStickers = {
            hat: false,
            glasses: false,
            beard: false
        };

        // í­ì£½ íŒŒí‹°í´ ë°°ì—´
        let particles = [];
        // í”„ë ˆì„ ì—…ë°ì´íŠ¸ ë£¨í”„ ì œì–´
        let lastResults = null;

        // ----------------------
        // 1. ìŠ¤í‹°ì»¤ ì´ë¯¸ì§€ (íŒŒì¼ + SVG í´ë°±)
        // ----------------------
        // ë°±ì—…ìš© SVG ë°ì´í„°
        const svgs = {
            hat: `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                    <path d="M10,80 Q50,-10 90,80 Z" fill="#D32F2F" />
                    <circle cx="50" cy="10" r="10" fill="white" />
                    <rect x="5" y="75" width="90" height="20" rx="10" fill="white" />
                </svg>`,
            glasses: `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 150 60">
                    <circle cx="35" cy="30" r="25" fill="black" opacity="0.8" />
                    <circle cx="115" cy="30" r="25" fill="black" opacity="0.8" />
                    <line x1="60" y1="30" x2="90" y2="30" stroke="black" stroke-width="5" />
                    <path d="M10,30 Q0,30 5,10" stroke="black" stroke-width="3" fill="none"/>
                    <path d="M140,30 Q150,30 145,10" stroke="black" stroke-width="3" fill="none"/>
                </svg>`,
            beard: `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 300">
                    <defs>
                        <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                            <feDropShadow dx="2" dy="4" stdDeviation="3" flood-opacity="0.2"/>
                        </filter>
                    </defs>
                    <path d="M40,110 Q20,150 40,190 Q60,240 150,240 Q240,240 260,190 Q280,150 260,110 Q230,140 150,140 Q70,140 40,110 Z" fill="#FFFFFF" stroke="#E5E5E5" stroke-width="2" filter="url(#shadow)"/>
                    <path d="M150,110 C120,70 40,80 30,120 Q25,140 60,130 C90,120 120,120 150,110" fill="#FFFFFF" stroke="#CCCCCC" stroke-width="2" filter="url(#shadow)"/>
                    <path d="M150,110 C180,70 260,80 270,120 Q275,140 240,130 C210,120 180,120 150,110" fill="#FFFFFF" stroke="#CCCCCC" stroke-width="2" filter="url(#shadow)"/>
                </svg>`
        };

        const stickerImages = {};
        
        // ì‚¬ìš©ìê°€ ì—…ë¡œë“œí•œ íŒŒì¼ëª… ë§¤í•‘ (ê¹ƒí—ˆë¸Œì— ì´ ì´ë¦„ ê·¸ëŒ€ë¡œ ì˜¬ë ¤ì•¼ í•©ë‹ˆë‹¤!)
        const stickerConfig = {
            hat: { file: 'christmas_hat.png', fallback: svgs.hat },
            glasses: { file: 'santa_glasses.png', fallback: svgs.glasses },
            beard: { file: 'mustache.png', fallback: svgs.beard } // mustache.png ì‚¬ìš©
        };

        // ì´ë¯¸ì§€ ë¡œë“œ ì‹œë„ (ì‹¤íŒ¨ ì‹œ SVG í´ë°± ì‚¬ìš©)
        Object.keys(stickerConfig).forEach(key => {
            const img = new Image();
            // 1. íŒŒì¼ ë¡œë“œ ì‹œë„
            img.src = stickerConfig[key].file;
            
            // 2. íŒŒì¼ì´ ì—†ìœ¼ë©´(ë¯¸ë¦¬ë³´ê¸° ë“±) SVG ì‚¬ìš©
            img.onerror = () => {
                const svgBlob = new Blob([stickerConfig[key].fallback], {type: 'image/svg+xml;charset=utf-8'});
                img.src = URL.createObjectURL(svgBlob);
            };
            
            stickerImages[key] = img;
        });

        // ----------------------
        // 2. MediaPipe Holistic ì„¤ì •
        // ----------------------
        const holistic = new Holistic({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`;
        }});

        holistic.setOptions({
            modelComplexity: 0, 
            smoothLandmarks: true,
            enableSegmentation: false,
            refineFaceLandmarks: false,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        holistic.onResults(onResults);

        const camera = new Camera(video, {
            onFrame: async () => {
                await holistic.send({image: video});
            },
            width: 640,
            height: 480
        });

        // ----------------------
        // 3. ë¡œì§ ë° ë Œë”ë§
        // ----------------------
        function onResults(results) {
            loading.style.display = 'none';
            lastResults = results; // AI ì¹´ë“œ ìƒì„±ì„ ìœ„í•´ ë§ˆì§€ë§‰ ê²°ê³¼ ì €ì¥

            canvas.width = results.image.width;
            canvas.height = results.image.height;

            drawScene(results);
        }

        function drawScene(results, overlayText = null) {
             ctx.save();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 1. ë¹„ë””ì˜¤ ê·¸ë¦¬ê¸°
            ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

            // 2. ì–¼êµ´ ìŠ¤í‹°ì»¤
            if (results.faceLandmarks) {
                drawFaceStickers(results.faceLandmarks);
            }

            // 3. ì† ì œìŠ¤ì²˜ (V) - í…ìŠ¤íŠ¸ ì˜¤ë²„ë ˆì´ ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ í­ì£½ ìƒì„±
            if (!overlayText) {
                const hands = [];
                if (results.leftHandLandmarks) hands.push(results.leftHandLandmarks);
                if (results.rightHandLandmarks) hands.push(results.rightHandLandmarks);

                if (hands.length > 0) {
                    for (const landmarks of hands) {
                        if (detectVGesture(landmarks)) {
                            if (Math.random() > 0.6) {
                                spawnFireworks(landmarks[8].x * canvas.width, landmarks[8].y * canvas.height);
                            }
                            if (Math.random() > 0.6) {
                                spawnFireworks(landmarks[12].x * canvas.width, landmarks[12].y * canvas.height);
                            }
                        }
                    }
                }
            }

            // 4. í­ì£½ ê·¸ë¦¬ê¸°
            updateAndDrawFireworks();

            // 5. AI í…ìŠ¤íŠ¸ ê·¸ë¦¬ê¸° (ì¹´ë“œ ëª¨ë“œì¼ ë•Œ)
            if (overlayText) {
                drawOverlayText(overlayText);
            }

            ctx.restore();
        }

        function drawOverlayText(text) {
            ctx.save();
            // ë°°ê²½ ìŠ¤íŠ¸ë¦½
            const boxHeight = 80;
            const y = canvas.height - boxHeight - 20;
            ctx.fillStyle = "rgba(0, 0, 0, 0.6)";
            ctx.fillRect(20, y, canvas.width - 40, boxHeight);
            
            // í…Œë‘ë¦¬
            ctx.strokeStyle = "#FFD700"; // Gold
            ctx.lineWidth = 3;
            ctx.strokeRect(20, y, canvas.width - 40, boxHeight);

            // í…ìŠ¤íŠ¸
            ctx.font = "bold 20px 'Malgun Gothic', sans-serif";
            ctx.fillStyle = "white";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            
            // í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ì²˜ë¦¬ (ê°„ë‹¨í•˜ê²Œ ê¸´ ê²½ìš° 2ì¤„ë¡œ)
            const maxWidth = canvas.width - 60;
            const words = text.split(' ');
            let line = '';
            let lines = [];

            for(let n = 0; n < words.length; n++) {
                let testLine = line + words[n] + ' ';
                let metrics = ctx.measureText(testLine);
                let testWidth = metrics.width;
                if (testWidth > maxWidth && n > 0) {
                    lines.push(line);
                    line = words[n] + ' ';
                } else {
                    line = testLine;
                }
            }
            lines.push(line);

            // í…ìŠ¤íŠ¸ ê·¸ë¦¬ê¸°
            const lineHeight = 30;
            let startY = y + (boxHeight - (lines.length * lineHeight)) / 2 + lineHeight/2;
            
            for(let i = 0; i < lines.length; i++) {
                ctx.fillText(lines[i], canvas.width / 2, startY + (i * lineHeight));
            }
            ctx.restore();
        }

        // ê±°ë¦¬ ê³„ì‚° í—¬í¼
        function dist(p1, p2) {
            return Math.hypot(p1.x - p2.x, p1.y - p2.y);
        }

        // V ì œìŠ¤ì²˜ ê°ì§€
        function detectVGesture(landmarks) {
            const wrist = landmarks[0];
            const isIndexOpen = dist(landmarks[8], wrist) > dist(landmarks[6], wrist);
            const isMiddleOpen = dist(landmarks[12], wrist) > dist(landmarks[10], wrist);
            const isRingClosed = dist(landmarks[16], wrist) < dist(landmarks[14], wrist);
            const isPinkyClosed = dist(landmarks[20], wrist) < dist(landmarks[18], wrist);
            const isSpread = dist(landmarks[8], landmarks[12]) > 0.04;
            return isIndexOpen && isMiddleOpen && isRingClosed && isPinkyClosed && isSpread;
        }

        // ----------------------
        // 4. í­ì£½ ì‹œìŠ¤í…œ
        // ----------------------
        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.size = Math.random() * 5 + 2;
                this.speedX = Math.random() * 6 - 3; 
                this.speedY = Math.random() * 6 - 3;
                this.color = color;
                this.life = 1.0;
            }
            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                this.speedY += 0.1; 
                this.life -= 0.03; 
                this.size *= 0.95;
            }
            draw(ctx) {
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1.0;
            }
        }

        function spawnFireworks(x, y) {
            const colors = ['#FF0000', '#00FF00', '#FFD700', '#FFFFFF'];
            const color = colors[Math.floor(Math.random() * colors.length)];
            for(let i=0; i<5; i++) {
                particles.push(new Particle(x, y, color));
            }
        }

        function updateAndDrawFireworks() {
            for (let i = particles.length - 1; i >= 0; i--) {
                particles[i].update();
                particles[i].draw(ctx);
                if (particles[i].life <= 0) {
                    particles.splice(i, 1);
                }
            }
        }

        // ----------------------
        // 5. ì–¼êµ´ ìŠ¤í‹°ì»¤
        // ----------------------
        function drawFaceStickers(landmarks) {
            const leftCheek = landmarks[454];
            const rightCheek = landmarks[234];
            const faceWidth = Math.hypot(
                (rightCheek.x - leftCheek.x) * canvas.width,
                (rightCheek.y - leftCheek.y) * canvas.height
            );
            
            const leftEye = landmarks[33];
            const rightEye = landmarks[263];
            const angle = Math.atan2(
                rightEye.y - leftEye.y,
                rightEye.x - leftEye.x
            );

            if (activeStickers.hat) {
                const topHead = landmarks[10];
                const img = stickerImages['hat'];
                const w = faceWidth * 1.5;
                const h = w * (img.height / img.width) || w;
                // ëª¨ì ìœ„ì¹˜ ì¡°ì • (ì‚´ì§ ìœ„ë¡œ)
                drawRotatedImage(img, topHead.x * canvas.width, topHead.y * canvas.height - (h * 0.5), w, h, angle);
            }

            if (activeStickers.glasses) {
                const noseBridge = landmarks[168];
                const img = stickerImages['glasses'];
                const w = faceWidth * 1.1;
                const h = w * 0.4;
                drawRotatedImage(img, noseBridge.x * canvas.width, noseBridge.y * canvas.height, w, h, angle);
            }

            if (activeStickers.beard) {
                const cx = landmarks[164].x * canvas.width;
                const cy = landmarks[164].y * canvas.height;
                const img = stickerImages['beard'];
                const w = faceWidth * 1.4;
                const h = w * 1.0; 
                drawRotatedImage(img, cx, cy + (h * 0.1), w, h, angle);
            }
        }

        function drawRotatedImage(image, x, y, w, h, angle) {
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(angle);
            ctx.drawImage(image, -w / 2, -h / 2, w, h);
            ctx.restore();
        }

        // ----------------------
        // 6. UI ì œì–´ ë° Gemini API
        // ----------------------
        function toggleSticker(type) {
            activeStickers[type] = !activeStickers[type];
            const btn = document.getElementById(`btn-${type}`);
            if (activeStickers[type]) {
                btn.classList.add('active', 'border-2', 'border-white');
            } else {
                btn.classList.remove('active', 'border-2', 'border-white');
            }
        }

        function resetAll() {
            activeStickers.hat = false;
            activeStickers.glasses = false;
            activeStickers.beard = false;
            ['hat', 'glasses', 'beard'].forEach(type => {
                document.getElementById(`btn-${type}`).classList.remove('active', 'border-2', 'border-white');
            });
        }

        function takePhoto() {
            saveImage(`christmas_photo_${Date.now()}.png`);
        }

        function saveImage(filename) {
            const link = document.createElement('a');
            link.download = filename;
            link.href = canvas.toDataURL(); 
            link.click();
        }

        // âœ¨ Gemini APIë¥¼ ì´ìš©í•œ AI ì¹´ë“œ ìƒì„± âœ¨
        async function generateAICard() {
            if (!apiKey) {
                alert("API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤! index.html íŒŒì¼ì„ ì—´ì–´ í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            if (!lastResults) return alert("ì¹´ë©”ë¼ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!");
            
            // 1. UI ìƒíƒœ ë³€ê²½ (ë¡œë”© ì‹œì‘)
            aiLoading.style.display = 'flex';
            
            try {
                // 2. í˜„ì¬ ìº”ë²„ìŠ¤ ì´ë¯¸ì§€ë¥¼ base64ë¡œ ìº¡ì²˜
                const imageData = canvas.toDataURL("image/jpeg").split(',')[1]; // í—¤ë” ì œê±°

                // 3. Gemini API í˜¸ì¶œ
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            role: "user",
                            parts: [
                                { text: "ì´ ì‚¬ì§„ì€ AR í•„í„° ì•±ìœ¼ë¡œ ì°ì€ í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ì‚¬ì§„ì´ì•¼. ì‚¬ì§„ ì† ì¸ë¬¼ì˜ í‘œì •ê³¼ ìŠ¤í‹°ì»¤(ëª¨ì, ì•ˆê²½, ìˆ˜ì—¼ ë“±)ë¥¼ ë³´ê³ , ì¹œêµ¬ì—ê²Œ ë³´ë‚¼ ì•„ì£¼ ì§§ê³  ì¬ì¹˜ìˆëŠ” í¬ë¦¬ìŠ¤ë§ˆìŠ¤ í•œ ë¬¸ì¥ ì¶•í•˜ ë©”ì‹œì§€ë¥¼ í•œê¸€ë¡œ ì‘ì„±í•´ì¤˜. ì¸ìš©êµ¬ ì—†ì´ í…ìŠ¤íŠ¸ë§Œ ì¤˜. ì´ëª¨ì§€ 1ê°œ í¬í•¨." },
                                { inlineData: { mimeType: "image/jpeg", data: imageData } }
                            ]
                        }]
                    })
                });

                const data = await response.json();
                
                // 4. ê²°ê³¼ í…ìŠ¤íŠ¸ ì¶”ì¶œ
                let generatedText = "ë©”ë¦¬ í¬ë¦¬ìŠ¤ë§ˆìŠ¤!";
                if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts) {
                    generatedText = data.candidates[0].content.parts[0].text.trim();
                } else {
                    console.error("API Error:", data);
                    generatedText = "í–‰ë³µí•œ ì„±íƒ„ì ˆ ë³´ë‚´ì„¸ìš”! ğŸ„";
                }

                // 5. í…ìŠ¤íŠ¸ë¥¼ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê³  ì €ì¥
                drawScene(lastResults, generatedText);
                
                // ì ì‹œ í›„ ì €ì¥ (ì‚¬ìš©ìê°€ ë³¼ ìˆ˜ ìˆê²Œ 0.5ì´ˆ ëŒ€ê¸°)
                setTimeout(() => {
                    saveImage(`christmas_ai_card_${Date.now()}.png`);
                    aiLoading.style.display = 'none';
                    // í…ìŠ¤íŠ¸ ì§€ìš°ê³  ì›ë˜ëŒ€ë¡œ ë³µê·€
                    drawScene(lastResults); 
                }, 1000);

            } catch (error) {
                console.error("Gemini Error:", error);
                alert("AI ì—°ê²° ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í‚¤ë¥¼ í™•ì¸í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                aiLoading.style.display = 'none';
            }
        }

        // ëˆˆ ë‚´ë¦¬ê¸°
        function createSnow() {
            const container = document.getElementById('snow-container');
            for(let i=0; i<30; i++) {
                const flake = document.createElement('div');
                flake.className = 'snowflake';
                flake.textContent = 'â„';
                flake.style.left = Math.random() * 100 + '%';
                flake.style.animationDelay = Math.random() * 10 + 's, ' + Math.random() * 3 + 's';
                flake.style.fontSize = (Math.random() * 10 + 10) + 'px';
                container.appendChild(flake);
            }
        }

        camera.start().catch(err => {
            console.error(err);
            loading.innerHTML = "<p class='text-red-500 font-bold'>ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨!<br>ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.</p>";
        });
        
        createSnow();
    </script>
</body>
</html>